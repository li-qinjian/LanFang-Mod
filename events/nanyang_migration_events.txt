namespace = nanyang_migration

# Nanyang Migration Event - Southeast Asian Perspective (Going Down to the Southern Seas)
nanyang_migration.1 = {
	type = country_event

	title = nanyang_migration.1.t
	desc = nanyang_migration.1.d
	flavor = nanyang_migration.1.f
	
	event_image = {
		video = "southamerica_factory_opening"
	}

	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"

	icon = "gfx/interface/icons/event_icons/event_map.dds"
	
	duration = 3
	
	trigger = {
		# Triggered by countries with Hakka culture as primary (e.g., Lanfang Republic and other Southeast Asian nations)
		any_primary_culture = {
			has_discrimination_trait = language_hakka
		}
		# Han culture mainstream country exists
		any_country = {
			any_primary_culture = {
				has_discrimination_trait = heritage_han
			}
		}
	}

	immediate = {
		# Find Han culture mainstream country (Qing or Taiping)
		random_country = {
			limit = {
				any_primary_culture = {
					has_discrimination_trait = heritage_han
				}
			}
			save_scope_as = han_country
			
			# Find the coastal state with highest unemployment rate in Hakka/Min homeland within Han country
			ordered_scope_state = {
				limit = {
					any_scope_pop = {
						has_discrimination_trait = heritage_han
						is_employed = no
					}
					is_coastal = yes
					state_region = {
						OR = {
							is_homeland = cu:hakka
							is_homeland = cu:min
							is_homeland = cu:yue
						}
					}
				}
				order_by = state_unemployment_rate
				position = 0
				save_scope_as = han_source_state
			}
		}
		
		# Find the incorporated state with highest migration pull in our country
		ordered_scope_state = {
			limit = {
				is_split_state = no
				is_coastal = yes
				has_port = yes
			}
			order_by = migration_pull
			position = 0
			save_scope_as = han_destination_state
		}
	}

	# Option A: Welcome Han migrants
	option = {
		name = nanyang_migration.1.a
		default_option = yes
		
		trigger = {
			exists = scope:han_source_state
			exists = scope:han_destination_state
		}
		
		custom_tooltip = {
			text = nanyang_migration_tooltip
			
			# Migrate unemployed Han population (including Hakka)
			scope:han_source_state = {
				ordered_scope_pop = {
					limit = {
						has_discrimination_trait = heritage_han
						is_employed = no
						OR = {
							is_pop_type = laborers
							is_pop_type = peasants
						}
					}
					save_scope_as = migrant_pop
					order_by = total_size
					position = 0
					check_range_bounds = no
					move_partial_pop = {
						state = scope:han_destination_state
						population = {
							# Move at most 5% of destination state's population, max 3000, or pop size, whichever is smaller
							add = scope:han_destination_state.state_population
							multiply = 0.05
							if = {
								limit = {
									scope:migrant_pop.pop_size >= 5000
								}
								max = 5000
							}
							else = {
								max = scope:migrant_pop.pop_size
							}
						}
					}
				}
			}
		}

		ai_chance = {
			base = 90
		}
	}

	# Option B: No available migrants or no suitable destination
	option = {
		name = nanyang_migration.1.c
		
		trigger = {
			OR = {
				NOT = { exists = scope:han_source_state }
				NOT = { exists = scope:han_destination_state }
			}
		}
		
		default_option = yes
		
		ai_chance = {
			base = 100
		}
	}
}
